# Настройка n8n Workflow для AI Job Scoring

Это руководство поможет вам настроить n8n workflow для автоматической оценки вакансий с помощью AI.

## Обзор

Бэкенд отправляет вакансии в n8n webhook, где они обрабатываются AI моделью и получают оценку от 1 до 10. Результаты отправляются обратно в бэкенд через webhook endpoint.

## Архитектура Workflow

```
[Webhook Trigger] → [AI Scoring] → [HTTP Request] → [Backend Webhook]
```

## Шаг 1: Создание Webhook Trigger

1. В n8n создайте новый workflow
2. Добавьте узел **Webhook**
3. Настройте узел:
   - **HTTP Method**: `POST`
   - **Path**: `/job-scoring` (или любой другой путь)
   - **Response Mode**: `Respond to Webhook`
4. Сохраните workflow и активируйте его
5. Скопируйте **Production URL** - это будет ваш `N8N_WEBHOOK_URL`

### Формат входящих данных

Бэкенд отправляет следующий payload:

```json
{
  "jobId": "uuid-here",
  "title": "Senior Full Stack Developer",
  "description": "Job description text..."
}
```

## Шаг 2: Добавление AI Scoring Node

1. Добавьте узел **OpenAI** (или другой AI сервис)
2. Настройте узел:
   - **Operation**: `Chat`
   - **Model**: `gpt-4` или `gpt-3.5-turbo`
   - **Messages**: Используйте следующий prompt:

```
Оцените следующую вакансию по шкале от 1 до 10, где:
- 1-3: Плохое совпадение, низкие требования или неинтересная позиция
- 4-6: Среднее совпадение, стандартные требования
- 7-8: Хорошее совпадение, интересная позиция
- 9-10: Отличное совпадение, идеальная позиция

Вакансия:
Название: {{ $json.title }}
Описание: {{ $json.description }}

Верните ответ в формате JSON:
{
  "score": <число от 1 до 10>,
  "reason": "<краткое обоснование оценки на русском языке>"
}
```

3. Настройте **Response Format**: `JSON`

## Шаг 3: Добавление HTTP Request Node для отправки результата

1. Добавьте узел **HTTP Request**
2. Настройте узел:
   - **Method**: `POST`
   - **URL**: `http://localhost:3000/webhooks/scoring` (или ваш production URL)
   - **Authentication**: None (или добавьте если требуется)
   - **Body Content Type**: `JSON`
   - **Body**: Используйте следующий JSON:

```json
{
  "jobId": "{{ $json.jobId }}",
  "score": {{ $('OpenAI').item.json.score }},
  "reason": "{{ $('OpenAI').item.json.reason }}"
}
```

**Примечание**: Замените `OpenAI` на имя вашего AI узла, если оно отличается.

## Шаг 4: Обработка ошибок (опционально)

Рекомендуется добавить обработку ошибок:

1. Добавьте узел **IF** после AI Scoring
2. Проверьте наличие ошибок
3. Добавьте узел **Error Trigger** для логирования ошибок

## Шаг 5: Тестирование

1. Убедитесь, что workflow активирован в n8n
2. Обновите `N8N_WEBHOOK_URL` в `.env` файле на Production URL из n8n
3. Запустите бэкенд: `npm run dev`
4. Вручную запустите загрузку вакансий: `POST http://localhost:3000/jobs/fetch`
5. Проверьте логи бэкенда и n8n для подтверждения работы

## Пример полного workflow

```
┌─────────────────┐
│  Webhook        │ ← Принимает вакансии от бэкенда
│  (POST)         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  OpenAI         │ ← Оценивает вакансию (1-10)
│  Chat           │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  HTTP Request   │ ← Отправляет результат в бэкенд
│  (POST)         │
└─────────────────┘
```

## Формат данных

### Входящий payload (от бэкенда в n8n)

```json
{
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "title": "Senior Full Stack Developer",
  "description": "We are looking for an experienced full stack developer..."
}
```

### Исходящий payload (от n8n в бэкенд)

```json
{
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "score": 8,
  "reason": "Отличная позиция для опытного разработчика. Требования соответствуют современным стандартам."
}
```

## Валидация данных

Бэкенд валидирует входящие данные:
- `jobId`: Должен быть валидным UUID
- `score`: Должен быть числом от 1 до 10
- `reason`: Должен быть непустой строкой

## Troubleshooting

### Проблема: Webhook не получает данные

- Проверьте, что workflow активирован в n8n
- Убедитесь, что URL в `.env` правильный
- Проверьте логи бэкенда на наличие ошибок отправки

### Проблема: AI не возвращает правильный формат

- Убедитесь, что в prompt указан формат JSON
- Проверьте настройки Response Format в OpenAI узле
- Добавьте узел для парсинга JSON если необходимо

### Проблема: Бэкенд не принимает результаты

- Проверьте формат данных (должен соответствовать схеме выше)
- Убедитесь, что `jobId` существует в базе данных
- Проверьте статус вакансии (должен быть `new`)
- Проверьте логи бэкенда для деталей ошибки

## Альтернативные AI сервисы

Вместо OpenAI можно использовать:
- **Anthropic Claude** - через HTTP Request узел
- **Google Gemini** - через соответствующий узел
- **Hugging Face** - через HTTP Request узел
- **Локальные модели** - через соответствующие узлы

Адаптируйте инструкции под выбранный сервис.
